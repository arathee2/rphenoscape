---
title: "Mutually Exclusive Phenotypes"
author: "Amandeep Rathee"
date: "1/9/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


The goal is to establish mutual exclusion in phenotypes. This vignette provides a pseudo code of a function that takes any two phenotypes and outputs whether they are mutually exclusive based on the phenoscape knowledgebase.

```{r include=TRUE, echo=TRUE, warning=FALSE, render=FALSE}

are_mutually_exclusive <- function(phenotype.a, phenotype.b, studies){
  
  # mutually_exclusive takes three values:
      # -1: default; we assume that before checking mutual exclusion, phenotypes are neither mutually exclusive nor mutually compatible
      #  0: data suggests mutual compatibility
      #  1: data suggests mutual exclusion
  mutually_exclusive <- -1
  
  
  
  # get states for each phenotype
  states.a <- get_state(phenotype.a)
  states.b <- get_state(phenotype.b)
  
  # filter studies that contain phenotype.a and phenotype.b
  studies.a <- sapply(states.a, is_phenotype_present(phenotype.a))
  studies.b <- sapply(states.b, is_phenotype_present(phenotype.b))
  
  # check mutually exclusive only if both phenotypes are part of at least one studies each.
  if((length(studies.a) == 0) | (length(studies.b) == 0)){
    print("At least one of the phenotypes is not part of any studies.")
    return(mutually_exclusive)  # return -1
  
  }else{ # CHECK MUTUAL EXCLUSIVITY
    
    # get character and character_state vectors
    chars.a <- vector()
    char_states.a <- vector()
    chars.b <- vector()
    char_states.b <- vector()
    
    for(study in studies.a){
      for(state in states.a){
      char <- get_chars(state, study)  # is this correct? If not, how to get characters from states and studies?
      chars.a <- c(chars.a, char)
      char_states.a <- c(char_states.a, paste(char, state, sep="_"))
      }
    }
    
    for(study in studies.b){
      for(state in states.b){
      char <- get_chars(state, study)
      chars.b <- c(chars.b, char)
      char_states.b <- c(char_states.b, paste(char, state, sep="_"))
      }
    }
    
    
    
    # determine if any two characters match
    char_matches <- sum(chars.a %in% chars.b)
  
    # CASE 1: if no characters match --> mutually compatible
    if(char_matches == 0){
      mutually_exclusive <- 0
      print("Phenotypes are mutually compatible.")
    
    # CASE 2: if characters match, look whether ALL states are different (mutually exclusive), or if any two states are same (mutually comptabile)
    } else {
      
      
        # CASE 2A: check whether ALL states are different wherever characters are same; if this is true --> mutually exclusive
        
        # for mutual exclusion, ALL wherever there's a character match, we should have a different state
        char_match_count = 0
        state_different_count = 0
        
        for(char_state.a in char_states.a){
          for (char_state.b in char_states.b){
            char.a <- get_char(char_state.a)    # use regex to get character from character_state value
            state.a <- get_state(char_state.a)  # use regex to get state from character_state value
            
            char.b <- get_char(char_state.b)
            state.b <- get_state(char_state.b)
            
            if(char.a == char.b){
              char_match_count = char_match_count + 1
              if(state.a != state.b){
                state_different_count = state_different_count + 1
              }
            }
          }
        }
        
        if(char_match_count == state_different_count){
          mutually_exclusive <- 1
          print("Phenotypes are mutually exclusive.")
        } else {
          # CASE 2B:check whether any two states match where characters are same --> mutually compatible
          compatibility_score <- sum(char_state.a %in% char_state.b)
          if(compatibility_score > 0){
            mutually_exclusive <- 0
            print("Phenotypes are mutually compatible.")
          }
          
        }
    }
      
    return(mutually_exclusive)
  }
  
  
  
}


```
---
title: "Mutually Exclusive Phenotypes"
author: "Amandeep Rathee"
date: '`r format(Sys.Date(), "%B-%d-%Y")`'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rphenoscape)
library(tidyverse)
```


This vignette showcases a function `are_mutually_exclusive` that establishes whether two phenotypes are mutually exclusive based on the phenoscape KB data.

```{r include=TRUE, echo=TRUE, warning=FALSE, render=FALSE}

are_mutually_exclusive <- function(phenotype.a, phenotype.b, studies, verbose=FALSE){
    
    # mutually_exclusive takes three values:
    # -1: default; we assume that before checking mutual exclusion, phenotypes are neither mutually exclusive nor mutually compatible
    #  0: data suggests mutual compatibility
    #  1: data suggests mutual exclusion
    mutually_exclusive <- -1
    
    # get charstates dataframe
    character_states <- charstates(c(phenotype.a, phenotype.b))
    
    # filter the character state dataframe based on phenotypes and studies
    charstates.a <- character_states[(character_states$phenotype.id == phenotype.a) & (character_states$study.id %in% studies), ]
    charstates.b <- character_states[(character_states$phenotype.id == phenotype.b) & (character_states$study.id %in% studies), ]
    
    # filter states based on phenotypes and studies
    states.a <- charstates.a$state.id
    states.b <- charstates.b$state.id
    
    # determine mutual exclusivity only if both study vectors are non-empty
    if((length(states.a) > 0) & (length(states.b) > 0)){ 
        
        # get character vectors
        chars.a <- unique(charstates.a$character.id)
        chars.b <- unique(charstates.b$character.id)
        
        # check intersection of character vectors
        char_matches <- sum(chars.a %in% chars.b)
        
        if(char_matches == 0){ 
            # CASE 1: if no characters match --> phenotypes are mutually compatible
            if(verbose){cat("No character match.\n")}
            mutually_exclusive <- 0
            
        } else { 
            # CASE 2: if one or more characters match --> investigate further
            
            if(intersection(charstates.a, charstates.b) == 0){
                # CASE 2-I: for matched characters, if no states are common among the matched characters --> phenotypes are mutually exclusive
                if(verbose){cat("Character match but no state match.\n")}
                mutually_exclusive <- 1
            } else {
                # CASE 2-II: if, for any matched characters, any two corresponding states match --> phenotypes are mutually compatible
                if(verbose){cat("Character match and state match.\n")}
                mutually_exclusive <- 0
            }
        }
        
        if(mutually_exclusive == -1){warning('Insufficient evidence to determine mutual exclusivity.')}  
        
    } else {
        if(length(states.a) == 0){
            mutually_exclusive <- NA
            warning("Phenotype A is not part of any of the studies passed. Both phenotypes are required to be part of at least one study.")
            
        } else if (length(states.b) == 0){
            mutually_exclusive <- NA
            warning("Phenotype B is not part of any of the studies passed. Both phenotypes are required to be part of at least one study.")
        } else {
            mutually_exclusive <- NA
            warning("Phenotypes A and B are not part of any of the studies passed. Both phenotypes are required to be part of at least one study.")
        }
    }
    
    mutually_exclusive
}

intersection <- function(charstate.a, charstate.b){
    
    # find intersection among character-states in phenotype A and B
    intersection <- intersect(charstate.a[, c('character.id', 'state.id')], 
                              charstate.b[, c('character.id', 'state.id')])
    
    # return number of items in intersection
    nrow(intersection)
}

mutual_exclusivity_matrix <- function(phenotypes, studies, header='id', progress=TRUE){
    # return square matrix of size length(phenotypes)
    # matrix has the following values
    # NA: phenotypes present in the row and column are not part of the studies provided
    # -1: default; insufficient data to conclude mutual exclusivity or compatibility
    #  0: phenotypes belonging to row and column are mutually compatible
    #  1: phenotypes belonging to row and column are mutually exclusive
    
    # initialize matrix
    num_phenotypes <- length(phenotypes)
    mutual_exclusivity_matrix <- matrix(-1, nrow=num_phenotypes, ncol=num_phenotypes)
    
    if(progress == FALSE){ # don't show progress bar
      
        # fill each cell of the matrix
        for (row in 1:num_phenotypes) {
            
            for (column in row:num_phenotypes) {
                
                if(row != column){ # compute mutual exclusivity among distinct phenotypes only
                    mutual_exclusivity <- are_mutually_exclusive(phenotypes[row], phenotypes[column], studies)
                    mutual_exclusivity_matrix[row, column] <- mutual_exclusivity
                    mutual_exclusivity_matrix[column, row] <- mutual_exclusivity
                } else if(row == column){
                    mutual_exclusivity_matrix[row, column] <- 0
                }
            }
        }
        
        if(header == 'label'){
            phenotype_labels <- sapply(phenotypes, function(p) as.character(pk_phenotype_detail(p)$label))
            rownames(mutual_exclusivity_matrix) <- phenotype_labels
            colnames(mutual_exclusivity_matrix) <- phenotype_labels
            
        } else if(header == 'int'){
            rownames(mutual_exclusivity_matrix) <- 1:length(phenotypes)
            colnames(mutual_exclusivity_matrix) <- 1:length(phenotypes)
        }
    } else { # show progress bar
      
        iteration <- 0
        num_me <- 0
        num_cp <- 0
        inconclusive <- 0
        # fill each cell of the matrix
        for (row in 1:num_phenotypes) {
            
            for (column in row:num_phenotypes) {
                
                iteration <- iteration + 1
                if(iteration != num_phenotypes^2){
                    cat('\014')
                    cat(paste0(round(iteration / (num_phenotypes^2) * 100, 4), '% completed\n', 
                               'Mutually exclusive pairs = ', num_me, '\n',
                               'Mutually compatible pairs = ', num_cp, '\n',
                               'Inconclusive evidence = ', inconclusive, '\n'))
                } else {
                    cat('\014');cat('\n Done!')
                }
                
                
                if(row != column){ # compute mutual exclusivity among distinct phenotypes only
                    mutual_exclusivity <- are_mutually_exclusive(phenotypes[row], phenotypes[column], studies)
                    mutual_exclusivity_matrix[row, column] <- mutual_exclusivity
                    mutual_exclusivity_matrix[column, row] <- mutual_exclusivity
                    if(mutual_exclusivity == 1){
                        num_me <- num_me + 1
                    } else if(mutual_exclusivity == -1){
                        inconclusive <- inconclusive + 1
                    } else if(mutual_exclusivity == 0){
                        num_cp <- num_cp + 1
                    }
                } else if(row == column){
                    mutual_exclusivity_matrix[row, column] <- 0
                }
            }
        }
    }
    
    mutual_exclusivity_matrix
}

# get studies
studies <- pk_get_study_list()
study <- studies$id[studies$label == 'Dillman et al. (2016)']

# get phenotypes
phenotypes <- get_phenotypes(study=study)
phenotypes <- phenotypes$id

# check mutual exclusivity
n <- 5
system.time(me <- mutual_exclusivity_matrix(phenotypes[1:n], study))
me
```
